<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Nowa rezerwacja</title>
</head>
<body>
  <h1>üìÜ Zarezerwuj pojazd</h1>

  <form id="reservationForm">
    <label>Pojazd:
      <select id="vehicleSelect" required></select>
    </label><br><br>

    <label>PoczƒÖtek:
      <input type="datetime-local" id="startTime" required>
    </label><br><br>

    <label>Koniec:
      <input type="datetime-local" id="endTime" required>
    </label><br><br>

    <button type="submit">Zarezerwuj</button>
  </form>

  <p id="result"></p>

  <script>
    async function loadVehicles() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Zaloguj siƒô najpierw!');
        window.location.href = 'loginpage.html';
        return;
      }

      const response = await fetch('http://localhost:8000/api/vehicles', {
        headers: {
          'Authorization': 'Bearer ' + token
        }
      });

      const data = await response.json();
      const select = document.getElementById('vehicleSelect');

      data.member.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle.id;
        option.dataset.price = vehicle.pricePerHour;
        option.text = `${vehicle.brand} ${vehicle.model} (${vehicle.licensePlate}) - ${vehicle.pricePerHour} z≈Ç/h`;
        select.appendChild(option);
      });
    }

    document.getElementById('reservationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const token = localStorage.getItem('token');
      const vehicleSelect = document.getElementById('vehicleSelect');
      const vehicleId = parseInt(vehicleSelect.value);
      const pricePerHour = parseFloat(vehicleSelect.selectedOptions[0].dataset.price);
      const start = new Date(document.getElementById('startTime').value);
      const end = new Date(document.getElementById('endTime').value);

      const hours = Math.max((end - start) / 3600000, 0.25); 
      const totalAmount = +(hours * pricePerHour).toFixed(2);

      const result = document.getElementById('result');

      try {
        
        const resResponse = await fetch('http://localhost:8000/api/reservations', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            vehicle: `/api/vehicles/${vehicleId}`,
            startTime: start.toISOString(),
            endTime: end.toISOString()
          })
        });

        if (!resResponse.ok) {
          const errorText = await resResponse.text();
          result.textContent = '‚ùå B≈ÇƒÖd rezerwacji: ' + errorText;
          return;
        }

        const reservation = await resResponse.json();

        
        const payResponse = await fetch('http://localhost:8000/api/payments', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            reservation: reservation['@id'] || `/api/reservations/${reservation.id}`,
            amount: totalAmount
          })
        });

        if (payResponse.ok) {
          result.textContent = `‚úÖ Rezerwacja i p≈Çatno≈õƒá dodane (${totalAmount} z≈Ç).`;
        } else {
          const payError = await payResponse.text();
          result.textContent = '‚ùå Rezerwacja dodana, ale b≈ÇƒÖd p≈Çatno≈õci: ' + payError;
        }

      } catch (err) {
        result.textContent = '‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z serwerem.';
        console.error(err);
      }
    });

    loadVehicles();
  </script>
</body>
</html>
